{"version":3,"file":"buildSwapTransaction.js","sources":["../../src/api/buildSwapTransaction.ts"],"sourcesContent":["import { RequestContext } from '@/core/network/constants';\nimport { SwapMessage } from '@/swap/constants';\nimport { UNSUPPORTED_AMOUNT_REFERENCE_ERROR_CODE } from '@/swap/constants';\nimport { CDP_GET_SWAP_TRADE } from '../core/network/definitions/swap';\nimport { sendRequest } from '../core/network/request';\nimport type { SwapAPIResponse } from '../swap/types';\nimport { getSwapErrorCode } from '../swap/utils/getSwapErrorCode';\nimport type {\n  BuildSwapTransactionParams,\n  BuildSwapTransactionResponse,\n  SwapAPIParams,\n} from './types';\nimport { getAPIParamsForToken } from './utils/getAPIParamsForToken';\nimport { getSwapTransaction } from './utils/getSwapTransaction';\n\n/**\n * Retrieves an unsigned transaction for a swap from Token A to Token B.\n */\nexport async function buildSwapTransaction(\n  params: BuildSwapTransactionParams,\n  _context: RequestContext = RequestContext.API,\n): Promise<BuildSwapTransactionResponse> {\n  // Default parameters\n  const defaultParams = {\n    amountReference: 'from' as const,\n    isAmountInDecimals: false,\n  };\n\n  let apiParams = getAPIParamsForToken({\n    ...defaultParams,\n    ...params,\n  });\n  if ('error' in apiParams) {\n    return apiParams;\n  }\n\n  if (params.useAggregator && params.amountReference === 'to') {\n    console.error(SwapMessage.UNSUPPORTED_AMOUNT_REFERENCE);\n    return {\n      code: UNSUPPORTED_AMOUNT_REFERENCE_ERROR_CODE,\n      error: SwapMessage.UNSUPPORTED_AMOUNT_REFERENCE,\n      message: '',\n    };\n  }\n\n  if (!params.useAggregator) {\n    apiParams = {\n      v2Enabled: true,\n      ...apiParams,\n    };\n  }\n  if (params.maxSlippage) {\n    let slippagePercentage = params.maxSlippage;\n    // Adjust slippage for V1 API (aggregator)\n    // V1 expects slippage in tenths of a percent (e.g., 30 = 3%)\n    if (params.useAggregator) {\n      slippagePercentage = (Number(params.maxSlippage) * 10).toString();\n    }\n    apiParams = {\n      slippagePercentage,\n      ...apiParams,\n    };\n  }\n\n  try {\n    const res = await sendRequest<SwapAPIParams, SwapAPIResponse>(\n      CDP_GET_SWAP_TRADE,\n      [apiParams],\n      _context,\n    );\n    if (res.error) {\n      return {\n        code: getSwapErrorCode('swap', res.error?.code),\n        error: res.error.message,\n        message: '',\n      };\n    }\n\n    const trade = res.result;\n    return {\n      approveTransaction: trade.approveTx\n        ? getSwapTransaction(trade.approveTx, trade.chainId)\n        : undefined,\n      fee: trade.fee,\n      quote: trade.quote,\n      transaction: getSwapTransaction(trade.tx, trade.chainId),\n      warning: trade.quote.warning,\n    };\n  } catch {\n    return {\n      code: getSwapErrorCode('uncaught-swap'),\n      error: 'Something went wrong',\n      message: '',\n    };\n  }\n}\n"],"names":[],"mappings":";;;;;;;AAkBA,eAAsB,qBACpB,QACA,WAA2B,eAAe,KACH;;AAEvC,QAAM,gBAAgB;AAAA,IACpB,iBAAiB;AAAA,IACjB,oBAAoB;AAAA,EACtB;AAEA,MAAI,YAAY,qBAAqB;AAAA,IACnC,GAAG;AAAA,IACH,GAAG;AAAA,EAAA,CACJ;AACD,MAAI,WAAW,WAAW;AACjB,WAAA;AAAA,EAAA;AAGT,MAAI,OAAO,iBAAiB,OAAO,oBAAoB,MAAM;AACnD,YAAA,MAAM,YAAY,4BAA4B;AAC/C,WAAA;AAAA,MACL,MAAM;AAAA,MACN,OAAO,YAAY;AAAA,MACnB,SAAS;AAAA,IACX;AAAA,EAAA;AAGE,MAAA,CAAC,OAAO,eAAe;AACb,gBAAA;AAAA,MACV,WAAW;AAAA,MACX,GAAG;AAAA,IACL;AAAA,EAAA;AAEF,MAAI,OAAO,aAAa;AACtB,QAAI,qBAAqB,OAAO;AAGhC,QAAI,OAAO,eAAe;AACxB,4BAAsB,OAAO,OAAO,WAAW,IAAI,IAAI,SAAS;AAAA,IAAA;AAEtD,gBAAA;AAAA,MACV;AAAA,MACA,GAAG;AAAA,IACL;AAAA,EAAA;AAGE,MAAA;AACF,UAAM,MAAM,MAAM;AAAA,MAChB;AAAA,MACA,CAAC,SAAS;AAAA,MACV;AAAA,IACF;AACA,QAAI,IAAI,OAAO;AACN,aAAA;AAAA,QACL,MAAM,iBAAiB,SAAQ,SAAI,UAAJ,mBAAW,IAAI;AAAA,QAC9C,OAAO,IAAI,MAAM;AAAA,QACjB,SAAS;AAAA,MACX;AAAA,IAAA;AAGF,UAAM,QAAQ,IAAI;AACX,WAAA;AAAA,MACL,oBAAoB,MAAM,YACtB,mBAAmB,MAAM,WAAW,MAAM,OAAO,IACjD;AAAA,MACJ,KAAK,MAAM;AAAA,MACX,OAAO,MAAM;AAAA,MACb,aAAa,mBAAmB,MAAM,IAAI,MAAM,OAAO;AAAA,MACvD,SAAS,MAAM,MAAM;AAAA,IACvB;AAAA,EAAA,QACM;AACC,WAAA;AAAA,MACL,MAAM,iBAAiB,eAAe;AAAA,MACtC,OAAO;AAAA,MACP,SAAS;AAAA,IACX;AAAA,EAAA;AAEJ;"}