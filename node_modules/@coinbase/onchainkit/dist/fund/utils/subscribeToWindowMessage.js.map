{"version":3,"file":"subscribeToWindowMessage.js","sources":["../../../src/fund/utils/subscribeToWindowMessage.ts"],"sourcesContent":["import { DEFAULT_ONRAMP_URL } from '../constants';\nimport type { JsonObject } from '../types';\n\nexport enum MessageCodes {\n  AppParams = 'app_params',\n  PaymentLinkSuccess = 'payment_link_success',\n  PaymentLinkClosed = 'payment_link_closed',\n  GuestCheckoutRedirectSuccess = 'guest_checkout_redirect_success',\n  Success = 'success',\n  Event = 'event',\n}\n\ntype MessageData = JsonObject;\n\n/**\n * Subscribes to a message from the parent window.\n * @param messageCode A message code to subscribe to.\n * @param onMessage Callback for when the message is received.\n * @param allowedOrigin The origin to allow messages from.\n * @param onValidateOrigin Callback to validate the origin of the message.\n * @returns\n */\nexport function subscribeToWindowMessage({\n  onMessage,\n  allowedOrigin = DEFAULT_ONRAMP_URL,\n  onValidateOrigin = () => Promise.resolve(true),\n}: {\n  onMessage: (data?: MessageData) => void;\n  allowedOrigin: string;\n  onValidateOrigin?: (origin: string) => Promise<boolean>;\n}) {\n  const handleMessage = (event: MessageEvent<string>) => {\n    if (!isAllowedOrigin({ event, allowedOrigin })) {\n      return;\n    }\n\n    const { eventName, data } = JSON.parse(event.data);\n\n    if (eventName === 'event') {\n      (async () => {\n        if (await onValidateOrigin(event.origin)) {\n          onMessage(data);\n        }\n      })();\n    }\n  };\n\n  window.addEventListener('message', handleMessage);\n\n  // Unsubscribe\n  return () => {\n    window.removeEventListener('message', handleMessage);\n  };\n}\n\nfunction isAllowedOrigin({\n  event,\n  allowedOrigin,\n}: {\n  event: MessageEvent;\n  allowedOrigin: string;\n}) {\n  const isOriginAllowed = !allowedOrigin || event.origin === allowedOrigin;\n  return isOriginAllowed;\n}\n"],"names":["MessageCodes"],"mappings":";AAGY,IAAA,iCAAAA,kBAAL;AACLA,gBAAA,WAAY,IAAA;AACZA,gBAAA,oBAAqB,IAAA;AACrBA,gBAAA,mBAAoB,IAAA;AACpBA,gBAAA,8BAA+B,IAAA;AAC/BA,gBAAA,SAAU,IAAA;AACVA,gBAAA,OAAQ,IAAA;AANEA,SAAAA;AAAA,GAAA,gBAAA,CAAA,CAAA;AAmBL,SAAS,yBAAyB;AAAA,EACvC;AAAA,EACA,gBAAgB;AAAA,EAChB,mBAAmB,MAAM,QAAQ,QAAQ,IAAI;AAC/C,GAIG;AACK,QAAA,gBAAgB,CAAC,UAAgC;AACrD,QAAI,CAAC,gBAAgB,EAAE,OAAO,cAAe,CAAA,GAAG;AAC9C;AAAA,IAAA;AAGF,UAAM,EAAE,WAAW,SAAS,KAAK,MAAM,MAAM,IAAI;AAEjD,QAAI,cAAc,SAAS;AACzB,OAAC,YAAY;AACX,YAAI,MAAM,iBAAiB,MAAM,MAAM,GAAG;AACxC,oBAAU,IAAI;AAAA,QAAA;AAAA,MAChB,GACC;AAAA,IAAA;AAAA,EAEP;AAEO,SAAA,iBAAiB,WAAW,aAAa;AAGhD,SAAO,MAAM;AACJ,WAAA,oBAAoB,WAAW,aAAa;AAAA,EACrD;AACF;AAEA,SAAS,gBAAgB;AAAA,EACvB;AAAA,EACA;AACF,GAGG;AACD,QAAM,kBAAkB,CAAC,iBAAiB,MAAM,WAAW;AACpD,SAAA;AACT;"}